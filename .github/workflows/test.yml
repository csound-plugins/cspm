on: [push]

jobs:
  testlinux:
    name: Test risset on linux
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: macos - install csound
        run: |
          sudo apt install csound
          ls /usr/lib/*csound*
          ls /usr/lib/*csnd*
          csound --version
          
      - name: macos - test install from git
        run: |
          pip install .
          risset update
          risset list
          risset install klib
          echo "-------------------------------"
          echo "Checking that the plugin is installed and recognized by csound"
          csound -z1 2>&1 | grep dict_
          risset remove klib
          pip uninstall --yes risset

      - name: macos - test install from pip
        if: runner.os == 'macos'
        run: |
          pip install risset -U
          risset update
          risset list
          risset install else
          echo "-------------------------------"
          echo "Checking that the plugin is installed and recognized by csound"
          csound -z1 2>&1 | grep atstop
          risset remove else
          pip uninstall --yes risset
          
  
    
  testwin:
    name: Test risset on windows
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: [ "3.10" ]
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: windows - install csound
        run: |
          curl -L -o csound-binaries.zip https://github.com/csound/csound/releases/download/6.18.1/Csound-6.18.1-windows-x64-binaries.zip
          Expand-Archive csound-binaries.zip -DestinationPath "C:\Program Files\csound-binaries"
          ls -r "C:\Program Files\csound-binaries"
          
          [Environment]::SetEnvironmentVariable("PATH", $Env:PATH + ";C:\Program Files\csound-binaries\build\Release", [EnvironmentVariableTarget]::Machine)
          $Env:Path = $Env:Path + ";C:\Program Files\csound-binaries\build\Release"
          Write-Output $Env:PATH
          csound.exe --version

      - name: windows - test install from git
        run: |
          $Env:Path = $Env:Path + ";C:\Program Files\csound-binaries\build\Release"
          
          pip install .
          risset update
          risset list
          risset install klib
          echo "-------------------------------"
          echo "Checking that the plugin is installed and recognized by csound"
          csound -z1 
          risset remove klib
          pip uninstall --yes risset

  testmacos:
    name: Test risset on macos
    runs-on: macos-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: macos - install csound
        run: |
          curl -L -o csound6.18.dmg https://github.com/csound/csound/releases/download/6.18.1/Csound-MacOS-universal-6.18.1.dmg
          brew install p7zip
          7z x csound6.18.dmg
          cd Csound-universal-6.18.1
          sudo installer -pkg csound-MacOS-universal-6.18.1.pkg -target /
          csound --version
          cd ..

      - name: macos - test install from git
        run: |
          pip install .
          risset update
          risset list
          risset install klib
          echo "-------------------------------"
          echo "Checking that the plugin is installed and recognized by csound"
          csound -z1 2>&1 | grep dict_
          risset remove klib
          pip uninstall --yes risset

      - name: macos - test install from pip
        run: |
          pip install risset -U
          risset update
          risset list
          risset install else
          echo "-------------------------------"
          echo "Checking that the plugin is installed and recognized by csound"
          csound -z1 2>&1 | grep atstop
          risset remove else
          pip uninstall --yes risset
          
  
